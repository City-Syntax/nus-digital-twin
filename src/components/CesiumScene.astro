---
import 'cesium/Build/Cesium/Widgets/widgets.css';
---

<style>
  #cesiumContainer {
    height: 100dvh;
    max-height: 100%;
  }
</style>

<script>
  window.CESIUM_BASE_URL = '/cesium';

  import { activePage, isLeftPanel, buildingProperties, searchQuery, buildingDataLayer } from '../navStore';

  import {
    Cartesian3,
    createOsmBuildingsAsync,
    Ion,
    Math as CesiumMath,
    Terrain,
    Viewer,
    Cesium3DTileStyle,
    IonImageryProvider,
    ImageryLayer,
    ScreenSpaceEventType,
    defined,
  } from 'cesium';

  Ion.defaultAccessToken = import.meta.env.PUBLIC_CESIUM_TOKEN;

  // Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.
  const viewer = new Viewer('cesiumContainer', {
    // TODO: Serve Sentinel-2 base layer to save on bandwidth
    baseLayer: ImageryLayer.fromProviderAsync(IonImageryProvider.fromAssetId(3954), {}),
    terrain: Terrain.fromWorldTerrain(),
    animation: false,
  });
  viewer.sceneModePicker.destroy();
  viewer.baseLayerPicker.destroy();

  var nusView = {
    destination: Cartesian3.fromDegrees(103.77678, 1.28342, 800),
    orientation: {
      heading: CesiumMath.toRadians(0.0),
      pitch: CesiumMath.toRadians(-30.0),
    },
  };

  // Set the home button view
  viewer.homeButton.viewModel.command.beforeExecute.addEventListener(function (commandInfo) {
    viewer.scene.camera.flyTo(nusView);
    commandInfo.cancel = true;
  });

  // Initial view
  viewer.camera.flyTo(nusView);

  // Add Cesium OSM Buildings, a global 3D buildings layer.
  const osmBuildingsTileset = await createOsmBuildingsAsync();
  viewer.scene.primitives.add(osmBuildingsTileset);

  osmBuildingsTileset.style = new Cesium3DTileStyle({
    show: {
      conditions: [
        ["${feature['cesium#longitude']} > 103.78171", false],
        ["${feature['cesium#longitude']} < 103.77022", false],
        ["${feature['cesium#latitude']} < 1.29088", false],
        ["${feature['cesium#latitude']} > 1.30824", false],
      ],
    },
  });

  const handler = viewer.screenSpaceEventHandler;
  handler.setInputAction(function (movement: any) {
    const pickedFeature = viewer.scene.pick(movement.position);
    if (!defined(pickedFeature)) {
      return;
    }

    if (defined(pickedFeature)) {
      activePage.set('BuildingInfo');
      isLeftPanel.set(true);
      const featureName = pickedFeature.getProperty('name') || '';
      buildingProperties.setKey('name', featureName || 'Unknown Building Name');
      searchQuery.set(featureName);
    }
  }, ScreenSpaceEventType.LEFT_CLICK);

  const nav = document.getElementById('nav');
  nav?.addEventListener('click', () => {
    // Timeout is necessary to allow for the state to update first
    setTimeout(() => {
      const showOsmBuildings = buildingDataLayer.get() === 'osm';
      if (showOsmBuildings) {
        osmBuildingsTileset.show = true;
      } else {
        osmBuildingsTileset.show = false;
      }
    });
  });
</script>

<div id="cesiumContainer"></div>
